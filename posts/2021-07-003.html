<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Phased diploid genome assembly with single-molecule real-time sequencing | The World</title><meta name="keywords" content="FALCON FalconSense Phased diploid genome assembly with single-molecule real-time sequencing"><meta name="author" content="归去来兮"><meta name="copyright" content="归去来兮"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="Phased diploid genome assembly with single-molecule real-time sequencing  仅代表个人理解，如果有不准确的欢迎指正   可能会用到的知识点  等位基因！！！！！！ SNP 单核苷酸多态性 SingleNucleotide Polymorphism 例如，对于某种生物，同一位置基因组片段一部分为AAGC CTA，另一部分为AA">
<meta property="og:type" content="article">
<meta property="og:title" content="Phased diploid genome assembly with single-molecule real-time sequencing">
<meta property="og:url" content="http://slyli.cn/posts/2021-07-003.html">
<meta property="og:site_name" content="The World">
<meta property="og:description" content="Phased diploid genome assembly with single-molecule real-time sequencing  仅代表个人理解，如果有不准确的欢迎指正   可能会用到的知识点  等位基因！！！！！！ SNP 单核苷酸多态性 SingleNucleotide Polymorphism 例如，对于某种生物，同一位置基因组片段一部分为AAGC CTA，另一部分为AA">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://slyli.github.io/img2/fav-sfw/wallhaven-0je5xw.jpg">
<meta property="article:published_time" content="2021-07-20T10:00:00.000Z">
<meta property="article:modified_time" content="2021-07-27T11:23:12.388Z">
<meta property="article:author" content="归去来兮">
<meta property="article:tag" content="bioinformatics">
<meta property="article:tag" content="essay">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://slyli.github.io/img2/fav-sfw/wallhaven-0je5xw.jpg"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/slyli/slyli.github.io/image/static/favicon.png"><link rel="canonical" href="http://slyli.cn/posts/2021-07-003"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><meta name="msvalidate.01" content="40800d7ddbfe4bc789367280a8addd52"/><meta name="baidu-site-verification" content="G9pFOrKi8Sw1jxpS"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?6facd0f053c5c32a56f404f1655089bb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-27 19:23:12'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="https://cdn.jsdelivr.net/gh/slyli/slyli.github.io/image/static/ava1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">43</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">35</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> Article</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-cube"></i><span> Entertain</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/steam/"><i class="fa-fw fab fa-steam"></i><span> Steam</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-folder"></i><span> Others</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/comment/"><i class="fa-fw fas fa-comment"></i><span> Comment</span></a></li><li><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></li><li><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></li><li><a class="site-page" target="_blank" rel="noopener" href="https://cloud.slyli.cn/cloud/"><i class="fa-fw fas fa-cloud"></i><span> Cloud</span></a></li><li><a class="site-page" target="_blank" rel="noopener" href="https://v.slyli.cn"><i class="fa-fw fa fa-clone"></i><span> Mirror</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw fa-fw fas fa-cubes"></i><span> Saying</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://slyli.github.io/img2/fav-sfw/wallhaven-0je5xw.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">The World</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> Article</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-cube"></i><span> Entertain</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/steam/"><i class="fa-fw fab fa-steam"></i><span> Steam</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-folder"></i><span> Others</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/comment/"><i class="fa-fw fas fa-comment"></i><span> Comment</span></a></li><li><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></li><li><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></li><li><a class="site-page" target="_blank" rel="noopener" href="https://cloud.slyli.cn/cloud/"><i class="fa-fw fas fa-cloud"></i><span> Cloud</span></a></li><li><a class="site-page" target="_blank" rel="noopener" href="https://v.slyli.cn"><i class="fa-fw fa fa-clone"></i><span> Mirror</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw fa-fw fas fa-cubes"></i><span> Saying</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Phased diploid genome assembly with single-molecule real-time sequencing</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-07-20T10:00:00.000Z" title="Created 2021-07-20 18:00:00">2021-07-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-07-27T11:23:12.388Z" title="Updated 2021-07-27 19:23:12">2021-07-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Master/">Master</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">3.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>12min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/posts/2021-07-003.html#post-comment"><span class="gitalk-comment-count"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="phased-diploid-genome-assembly-with-single-molecule-real-time-sequencing"><a class="markdownIt-Anchor" href="#phased-diploid-genome-assembly-with-single-molecule-real-time-sequencing"></a> <a target="_blank" rel="noopener" href="https://www.nature.com/articles/nmeth.4035">Phased diploid genome assembly with single-molecule real-time sequencing</a></h1>
<blockquote>
<p>仅代表个人理解，如果有不准确的欢迎指正</p>
</blockquote>
<h2 id="可能会用到的知识点"><a class="markdownIt-Anchor" href="#可能会用到的知识点"></a> 可能会用到的知识点</h2>
<ul>
<li>等位基因！！！！！！</li>
<li>SNP 单核苷酸多态性 SingleNucleotide Polymorphism 例如，对于某种生物，同一位置基因组片段一部分为<code>AAGC CTA</code>，另一部分为<code>AAGC T TA</code>，则认为此处存在SNP、两种基因型属于等位基因。</li>
<li>VS 结构体变异 Structural variation 生物染色体上结构的变异，多指涉长度介于1Kb与3Mb之间的序列大于单核苷酸多态性并且小于染色体畸变</li>
</ul>
<h2 id="main"><a class="markdownIt-Anchor" href="#main"></a> Main</h2>
<p>单分子实时测序技术 Single-molecule real-time (SMRT) 可以为哺乳动物提供高连续性的组装，long read 可以横跨多个重复区域，和帮助解决复杂的双倍体基因，本文提供了 FALCON 一个双倍体敏感的 long read 组装工具，FALCON-Unzip 一个相关的单倍体解析工具，用正确的同源染色体来组装代表具有 正确 定相 同源染色体的二倍体基因组的单倍体 contigs</p>
<img src= "https://cdn.jsdelivr.net/gh/slyli/slyli.github.io/image/static/loading.gif" data-lazy-src="https://media.springernature.com/full/springer-static/image/art%3A10.1038%2Fnmeth.4035/MediaObjects/41592_2016_Article_BFnmeth4035_Fig1_HTML.jpg" >
<pre><code>(a) 使用 FALCON 的一个最初的组装结果，先对原始 reads 纠错，然后通过关于 overlap 的 string graph 组装，组装后的 contigs 通过 FALCON-Unzip 完善成最后的 contigs 和 haplotigs
(b) Phase heterozygous SNPs and group reads by haplotype. 
(c) The phased reads are used to open up the haplotype-fused path and generate as output a set of primary contigs and associated haplotigs.
</code></pre>
<p>FALCON assembler 首先用 reads 构建了包含单倍体融合（haplotype-fused）的 contigs和同源序列不同区域气泡的 string graph （a）。<br />
FALCON-Unzip 使用来自其识别的杂合位置的定相信息识别读取单倍型（b）。</p>
<h2 id="method"><a class="markdownIt-Anchor" href="#method"></a> Method</h2>
<h3 id="raw-long-read-error-correction"><a class="markdownIt-Anchor" href="#raw-long-read-error-correction"></a> Raw long-read error correction</h3>
<p>使用 daligner 把所有的 read 都 align 到任意其他 read，这些 overlap 和 read 信息用 FALCON-sense 于生成 consensus 序列。FALCON-sense 算法可以保留杂合 SNP 的信息</p>
<h2 id="supplementary-information"><a class="markdownIt-Anchor" href="#supplementary-information"></a> Supplementary information</h2>
<h3 id="updated-falcon-consensus-algorithm"><a class="markdownIt-Anchor" href="#updated-falcon-consensus-algorithm"></a> Updated FALCON consensus algorithm</h3>
<img src= "https://cdn.jsdelivr.net/gh/slyli/slyli.github.io/image/static/loading.gif" data-lazy-src="https://media.springernature.com/full/springer-static/image/art%3A10.1038%2Fnmeth.4035/MediaObjects/41592_2016_Article_BFnmeth4035_Fig14_ESM.jpg" >
<pre><code>图中虚线突出显示了两条路径，青色虚线表示种子序列的路径，绿色虚线表示最后的 consensus 路径，Node “0092:0:T:T” 被认为是种子 read 上错误的额外碱基。新 Nodes 0091:0:-:C” and “0091:0:-:A” 添加到 consensus 路径，绿色箭头突出了原始的模板序列，插入到种子序列的 “CA” 与原始模板一致，也就是说，consensus 纠正了3个种子 read 中模拟的错误
</code></pre>
<p>FALCON-sense 使用一系列种子序列和支持他们的 reads 产生每个种子序列的 consensus</p>
<ol>
<li>使用 Gene Myers’ O(ND) aligner 把支持种子序列的 reads align 到种子序列上，在 alignment 中只允许插入和删除，不允许存在错配</li>
<li>在 alignment 的每一个位置都生成一个 alignment tag，tag 包含4个方面
<ol>
<li>在种子序列上的锚点位置</li>
<li>种子序列上锚点位置的 delta （插入的base数量）</li>
<li>种子序列上的base（碱基）</li>
<li>alignment 中支持序列上的base</li>
</ol>
</li>
</ol>
<p>当在给定位置上的支持read相对于种子序列有插入时，alignment 上插入的 base 的非零 delta 表示来自锚点位置的 base 数量。tag 1 和 3 有相同的信息，只是表示不同，加入3只是为了方便</p>
<ol>
<li>根据支持reads的 tag 构建一个 alignment graph
<ol>
<li>对于每个不同的tag，构建一个相应的node</li>
<li>对于 支持 read 上连续的tag，在图上创建一条边并给这条边上的 edge_count 赋值 1，如果这条边之前存在则 edge_count 的值 +1 ，结果是一个单项无环图（DAG），每一个 node 都有 tag，edge_count 表明有多少个read支持两个 nodes 之间的链接，edge_count 值越大表明支持 reads 上 nodes 之间的连接越可靠，一个高质量的 consensus sequence 也就是通过这些高可靠性的 edge 连接起来的 nodes 形成的一条链</li>
</ol>
</li>
<li>在 alignment graph 上使用标准的动态规划算法找到最可靠的路径，通过串联路径上 tags 上的 bases 产生 consensus sequence</li>
</ol>
<h3 id="assembly-string-graph-reduction-process-summary"><a class="markdownIt-Anchor" href="#assembly-string-graph-reduction-process-summary"></a> Assembly string graph reduction process summary</h3>
<h4 id="constructing-the-initial-string-graph"><a class="markdownIt-Anchor" href="#constructing-the-initial-string-graph"></a> Constructing the initial string graph</h4>
<p>在纠正完 reads 后，使用 daligner 获取 reads 间的 overlap。然后 overlap-filtering 步骤过滤掉已包含的 reads 和出现在高度重复区域的 reads。使用 Myers’ paper (Myers 2005)上的方法，根据过滤后的 reads pairs 构建 string graph。 本文通过 overlap 构建普通的单向图，每对 overlap 实际上构建了两条有向的边， 但是我们只需要沿着一个方向延伸，以获取 contigs 和它们反向互补相对应的部分。也就是说，在最终的 contigs 中只有每对有向边的一条。在构建结构阶段，我们根据每对边的对称性去除冗余。.</p>
<h4 id="a-heuristic-algorithm-for-constructing-compound-paths-启发式算法构建复合路径"><a class="markdownIt-Anchor" href="#a-heuristic-algorithm-for-constructing-compound-paths-启发式算法构建复合路径"></a> A heuristic algorithm for constructing compound paths 启发式算法构建复合路径</h4>
<p>概念上讲，bubble 表示子图，就像（1）只有一个源节点和一个宿节点，（2）源节点到宿节点有多条路径，（3）在去掉任意一条边后，都保持着弱连接。复杂的杂合结构变异或二倍体数据集中两个单倍型之间的重复区域可能会导致更复杂的结构。</p>
<p>(1) 可能有嵌套 bubbles</p>
<pre><code>              _______   
       ______/       \________ 
      /      \_______/        \______ 
_____/                        / 
     \_______________________/ 
</code></pre>
<p>(2) 图中也能有环</p>
<pre><code>              ___&lt;___   
       ______/       \________ 
      /   &gt;  \_______/   &gt;    \______ 
_____/           &gt;            / 
     \_______________________/ 
                 &gt; 
</code></pre>
<p>(3) 还有非常复杂的嵌套 bubbles，这可能表示某些局部复杂重复难以解决</p>
<pre><code>        ______________ 
       /        /     \ 
      /________/ \   / \ 
     /____________\_/   \_______ 
____/___________________/   / 
    \______/    /__________/ 
     \_____\___/ 
</code></pre>
<p>Falcon 用于寻找 bubbles 的复合路径的启发式方法如下所示：</p>
<ol>
<li>把最初组装的 string graph 简化成一个具有简单路径的图。也即是说，把没有分支节点路径上的所有边变成一条边，把这个称为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>U</mi><msub><mi>G</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">UG_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></li>
<li>对 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>U</mi><msub><mi>G</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">UG_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 中每个有多条出边的节点，搜索边的本地 bundle。设置 active tracers 追踪每个节点的每个分支
<ol>
<li>每次迭代都检查节点是否有 active tracers，如果一个节点的所有入节点都有一个 tracer ，给他的子节点添加 tracer 并且使它父节点的 tracer 变成 inactive，如果只剩一个 active tracer，那么多有遍历过的节点和边形成的子图称为复合路径（compound path）</li>
<li>如果任意一个active tracer 节点的后代有用过的 tracer，就表明探测到了一个循环，此时停止搜索并且不产生复合路径</li>
<li>基因复杂重复的部分，active tracer 会快速增加。限制 active tracer 的数量可以避免不必要的计算。如果数量超过了预设值，就停止搜索</li>
<li>对于每一步我们可以计算节点的数量和路径长度，路径长度可以看做从源节点开始到所有带有 active tracer 的节点的路径中有最多数量 bases 的路径。如果节点的数量或路径长度超过预设值，停止搜索</li>
</ol>
</li>
<li>某些复合路径和其他路径之间有重叠部分，或者一个包含另一个，这样的小的 bubbles 是大 bubble 嵌入的一部分，这种情况下选择大的忽略小的</li>
</ol>
<img src= "https://cdn.jsdelivr.net/gh/slyli/slyli.github.io/image/static/loading.gif" data-lazy-src="https://media.springernature.com/full/springer-static/image/art%3A10.1038%2Fnmeth.4035/MediaObjects/41592_2016_Article_BFnmeth4035_Fig16_ESM.jpg" width="75%" >
<pre><code>每个复合路径都是$UG_0$中简单路径的集合，$UG_0$中的简单路径可以被新确定的复合路径代替，可以形成一个联合图，图中的边要么是简单路径要么是复合路径。下一步是在联合图中确定没有分支的路径，和沿着边串联序列来产生 contigs。
</code></pre>
<h4 id="from-sequence-overlaps-to-primary-and-associated-contigs"><a class="markdownIt-Anchor" href="#from-sequence-overlaps-to-primary-and-associated-contigs"></a> From sequence overlaps to primary and associated contigs</h4>
<p>上图总结了从纠错后的 read 通过多个图简化步骤到 contigs 的整个步骤。首先，把图分解成简单路径和复合路径，通过结合复合路径和简单路径构建出原始的 contig。这些 contig 仍然是单倍体混合的 contig。也就是说，不同区域的原始 contig 可能来自不同的单倍体，在这个阶段，布局规则不保证单倍体一致性，而且，两个单倍体之间有少部分不同时，不会有关联的 contig 生成。可以使用 ALCON-Unzip 去分离单倍体序列和生成单倍体相关的 contig。</p>
<h4 id="a-greedy-snps-phasing-algorithm"><a class="markdownIt-Anchor" href="#a-greedy-snps-phasing-algorithm"></a> A greedy SNPs phasing algorithm</h4>
<p>构建单倍体序列，需要分离同源的 reads 到不同的组中，步骤如下：</p>
<ol>
<li>
<p>查看 read 在原始 contig 中的位置，在 read 和 contig 之间生成 alignment，有两种策略</p>
<ol>
<li>检查组装期间生成的 overlap 数据，确定属于每个特定 contig 的 reads 并把这些 reads 重新 align 到特定的 contig</li>
<li>简单的把 read align 到组装后的 contig</li>
</ol>
<p>对于第一种，首先检查每个contig的平铺路径，检查完组装步骤生成的 overlap 数据后，每个 read 都可能和原始 overlap 数据中，分配到contig或未分配的有 overlap。分配给 contig 有 overlap 的 reads 可能不是来自同一个 contig。需要打分决定那个是最好的，通过 overlap 的长度给他们打分。如果有 overlap 最好的一对 read 被分配给了 contig，那么未分配的查询 read 也分配给这个 contig。把 reads 分组分成和原始 contig 相关的集合，每个集合和他们的 reads 分别独立的进行 align。策略1因为可以重新使用存在的 overlap 数据，可以节约算力</p>
</li>
<li>
<p>对每个 contig 调用 het-SNPs。对于大多数单倍体重构算法都需要 het-SNPs 结果作为输入，我们使用简单的 alignment 和计数方法来调用 het-SNPs。使用 BLASR 把 read 比对到 contig 上，生成 BAM/SAM 文件，只关注 SNP 并且忽略附近有插入或删除的 SNP ，也就是说只记录 BAM 文件 CIGAR 中的 “M” 模块。对于 contig 中的每个 base，记录 aligned read 每个 A、G、C、T 的数量，如果数量最高的小于75%，并且第二的大于25%,我们称之为一个 het-SNP位点，并且这两个 bases 作为 SNP 定相下游的两个等位基因 base</p>
</li>
</ol>
<img src= "https://cdn.jsdelivr.net/gh/slyli/slyli.github.io/image/static/loading.gif" data-lazy-src="https://media.springernature.com/full/springer-static/image/art%3A10.1038%2Fnmeth.4035/MediaObjects/41592_2016_Article_BFnmeth4035_Fig17_ESM.jpg" width="80%" >
<pre><code>(a) All pairs of het-SNPs that are covered by multiple reads are evaluation. A “coupling score” is calculation from the number reads that support current haplotype assignment of the het-SNPs. (b)(c) We linearly scan through the het-SNP positions. If the total score is improved by flipping the haplotype assigned at one location, then we flip the assignment. (d) An example showing the “coupling score” before the flipping process (un-phased het-SNPs assignment) and afterward (phased het-SNP assignment).
</code></pre>
<ol>
<li>
<p>对每个 het-SNPs 定向。使用简单的贪婪算法在不同的单倍体组中定相 SNPs ，一般模型如上图所示。For<br />
each het-SNP site, the initial phase of the variants are randomly chosen.  For any two sites<br />
that have shared reads mapped on, we can calculate a “coupling score”.  The “coupling<br />
score” is defined simply as the number of reads supporting the particular phase.  Along the<br />
reference, we scan the het-SNP sites from the 5’-end to 3’-end. We test the two possible<br />
choices of the phase at the given site for each het-SNP site. The choice with more “coupling<br />
score” support is kept.  When there are fewer than 6 reads connecting two het-SNP sites,<br />
we break the haplotype blocks. We apply this scanning and updating process iteratively<br />
until no more optimization of the score is possible or reach a pre-specified limit of<br />
iterations.  At the end of this process, the het-SNP sites along the reference will be grouped<br />
into different haplotype blocks and we have a set of phased SNPs associated with each<br />
block.</p>
</li>
<li>
<p>Assign phases to the raw reads. For each read, we examine the alignment to the reference.<br />
If the read contain het-SNP calls against the reference, we count which phases it agrees the<br />
most and assign a tuple of “(block identifier, phase identifier)” to the read.  For reads where<br />
no haplotype block and phase assignment is possible, e.g. reads without enough het-SNP<br />
calls, we simply assign a sentinel value for the block identifier to trace the un-phased reads.</p>
</li>
</ol>
<p>The phasing method presented here is rather generic. It performs reasonably as shown in the<br />
evaluation work presented in the main manuscript. We anticipate if we integrate more<br />
sophisticate algorithms for phasing can further increase the accuracy and phasing contiguity.</p>
<h4 id="incorporate-phased-reads-to-haplotype-fused-string-graph-for-unzipping-collapsed-paths"><a class="markdownIt-Anchor" href="#incorporate-phased-reads-to-haplotype-fused-string-graph-for-unzipping-collapsed-paths"></a> Incorporate phased reads to haplotype-fused string graph for unzipping collapsed paths</h4>
<img src= "https://cdn.jsdelivr.net/gh/slyli/slyli.github.io/image/static/loading.gif" data-lazy-src="https://media.springernature.com/full/springer-static/image/art%3A10.1038%2Fnmeth.4035/MediaObjects/41592_2016_Article_BFnmeth4035_Fig15_ESM.jpg" width="75%" >
<p>(a) shows the schematic of how to merge the haplotype specific<br />
assembly graph  Hc to the initial haplotype-fused graph Gc<br />
(f)and reconstruct the haplotype<br />
tiling paths for generating the haplotigs.  The haplotype specific assembly graph has 4<br />
disconnected subgraphs inside the cyan boxes, two for each haplotype.  If we add the edges<br />
and nodes from the  Hc to the haplotype-fused graph in the yellow box, we get the<br />
intermediate graph shown in the upper right panle.  In the graph, the red nodes and blue nodes<br />
indicate the reads from the two different haplotypes.  There are some edges connecting the<br />
nodes from two different haplotypes. Once the haplotype of the reads are known, we can<br />
remove those edges. This results in the graph in lower panel. We can construct the tiling paths<br />
for the two haplotigs from the two disconnected and haplotype specific components.</p>
<p>(b)shows an example constructing the primary contig and haplotigs<br />
from the Clavicorona pyxidata assembly. Along the initial primary contig, we can find 4<br />
haplotype blocks and an un-phased region.  By applying the FALCON-Unzip process, we bring<br />
back some reads to fully reconstruct the haplotigs. In this example, the four initial haplotype<br />
block can be further merged by the overlaps across the bubbles in the assembly graph.</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">归去来兮</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://slyli.cn/posts/2021-07-003.html">http://slyli.cn/posts/2021-07-003.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/bioinformatics/">bioinformatics</a><a class="post-meta__tags" href="/tags/essay/">essay</a></div><div class="post_share"><div class="social-share" data-image="https://slyli.github.io/img2/fav-sfw/wallhaven-0je5xw.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/2021-07-240.html"><img class="prev-cover" data-lazy-src="https://slyli.github.io/img2/fav-sfw/wallhaven-0jepq4.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Canu: scalable and accurate long-read assembly via adaptive k-mer weighting and repeat separation</div></div></a></div><div class="next-post pull-right"><a href="/posts/2021-07-002.html"><img class="next-cover" data-lazy-src="https://slyli.github.io/img2/fav-sfw/wallhaven-01kgv4.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">MECAT: fast mapping, error correction, and de novo assembly for single-molecule sequencing reads</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/posts/2021-07-240.html" title="Canu: scalable and accurate long-read assembly via adaptive k-mer weighting and repeat separation"><img class="cover" data-lazy-src="https://slyli.github.io/img2/fav-sfw/wallhaven-0jepq4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-24</div><div class="title">Canu: scalable and accurate long-read assembly via adaptive k-mer weighting and repeat separation</div></div></a></div><div><a href="/posts/2021-09-150.html" title="DAGCON"><img class="cover" data-lazy-src="https://slyli.github.io/img2/fav-sfw/wallhaven-0pkex9.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-15</div><div class="title">DAGCON</div></div></a></div><div><a href="/posts/2021-07-002.html" title="MECAT: fast mapping, error correction, and de novo assembly for single-molecule sequencing reads"><img class="cover" data-lazy-src="https://slyli.github.io/img2/fav-sfw/wallhaven-01kgv4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-15</div><div class="title">MECAT: fast mapping, error correction, and de novo assembly for single-molecule sequencing reads</div></div></a></div><div><a href="/posts/2021-03-002.html" title="基因组文件处理"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/slyli/img1/wallpaper/wallhaven-xlq1rv.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-17</div><div class="title">基因组文件处理</div></div></a></div><div><a href="/posts/2021-03-001.html" title="基因组组装"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/slyli/img1/wallpaper/wallhaven-vg7lv3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-11</div><div class="title">基因组组装</div></div></a></div><div><a href="/posts/2021-03-003.html" title="测序数据解释"><img class="cover" data-lazy-src="https://slyli.github.io/img2/fav-sfw/wallhaven-011zk3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-22</div><div class="title">测序数据解释</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div><div id="comment-switch"><span class="first-comment">Gitalk</span><span class="switch-btn"></span><span class="second-comment">Valine</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#phased-diploid-genome-assembly-with-single-molecule-real-time-sequencing"><span class="toc-number">1.</span> <span class="toc-text"> Phased diploid genome assembly with single-molecule real-time sequencing</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E8%83%BD%E4%BC%9A%E7%94%A8%E5%88%B0%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">1.1.</span> <span class="toc-text"> 可能会用到的知识点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#main"><span class="toc-number">1.2.</span> <span class="toc-text"> Main</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#method"><span class="toc-number">1.3.</span> <span class="toc-text"> Method</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#raw-long-read-error-correction"><span class="toc-number">1.3.1.</span> <span class="toc-text"> Raw long-read error correction</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#supplementary-information"><span class="toc-number">1.4.</span> <span class="toc-text"> Supplementary information</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#updated-falcon-consensus-algorithm"><span class="toc-number">1.4.1.</span> <span class="toc-text"> Updated FALCON consensus algorithm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#assembly-string-graph-reduction-process-summary"><span class="toc-number">1.4.2.</span> <span class="toc-text"> Assembly string graph reduction process summary</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#constructing-the-initial-string-graph"><span class="toc-number">1.4.2.1.</span> <span class="toc-text"> Constructing the initial string graph</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#a-heuristic-algorithm-for-constructing-compound-paths-%E5%90%AF%E5%8F%91%E5%BC%8F%E7%AE%97%E6%B3%95%E6%9E%84%E5%BB%BA%E5%A4%8D%E5%90%88%E8%B7%AF%E5%BE%84"><span class="toc-number">1.4.2.2.</span> <span class="toc-text"> A heuristic algorithm for constructing compound paths 启发式算法构建复合路径</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#from-sequence-overlaps-to-primary-and-associated-contigs"><span class="toc-number">1.4.2.3.</span> <span class="toc-text"> From sequence overlaps to primary and associated contigs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#a-greedy-snps-phasing-algorithm"><span class="toc-number">1.4.2.4.</span> <span class="toc-text"> A greedy SNPs phasing algorithm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#incorporate-phased-reads-to-haplotype-fused-string-graph-for-unzipping-collapsed-paths"><span class="toc-number">1.4.2.5.</span> <span class="toc-text"> Incorporate phased reads to haplotype-fused string graph for unzipping collapsed paths</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 归去来兮</div><div class="footer_custom_text">All Right Reserved  <a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/"><img class="icp-icon" src="https://cdn.jsdelivr.net/gh/slyli/slyli.github.io/image/static/icp.png"><span>鲁ICP备2021044846号-1</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', '', 'katex-wrap')
  })
})()</script><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk({
      clientID: 'e19f7a3f5790b3cdd656',
      clientSecret: '4c94d6a5fdffc731957d1222b75df676b21e4fcc',
      repo: 'slyli.github.io',
      owner: 'SlyLi',
      admin: ['SlyLi'],
      id: '3a6e5bc36450d7d98f96c700ec556877',
      language: 'en',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    })
    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'a6SkEWr1cDgiFLXRdcU3DkUn-gzGzoHsz',
      appKey: 'LaMtrAthbpM4HvRmTUUilSbo',
      placeholder: '昵称框输入QQ号自动获取必填信息~',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: true,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick,mail'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign(initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Gitalk' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<[^>]+>/g,"") // remove html tag
    content = content.replace(/(http(s?):)([/|.|\w|\s|-])*\.(?:jpg|jpeg|gif|png|webp)/g, '') // remove image link
    content = content.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi, '') // remove url

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    fetch('https://api.github.com/repos/https://github.com/SlyLi/slyli.github.io/issues/comments?sort=updated&direction=desc&per_page=6&page=1')
      .then(response => response.json())
      .then(data => {
        const githubArray = data.map(item => {
          return {
            'avatar': item.user.avatar_url,
            'content': changeContent(item.body),
            'nick': item.user.login,
            'url': item.html_url,
            'date': item.updated_at
          }
        })
        saveToLocal.set('github-newest-comments', JSON.stringify(githubArray), 10/(60*24))
        generateHtml(githubArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "Unable to get the data, please make sure the settings are correct."
      })
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          let name = 'src'
          if(true) {
            name = 'data-lazy-src'
          }
          result += `<a href='${array[i].url}' class="thumbnail"><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick}</span><time> / ${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += 'No Comment'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('github-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><div> <div class="aplayer no-destroy" data-id="6888515029" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="false" data-mutex="true"	 muted></div> <script type="text/javascript">
function PlayerVisibility() { var pathname = document.location.pathname; var box = document.getElementsByClassName("aplayer no-destroy")[0];
if(box) { if(pathname == "/music/") { box.style.visibility="hidden"; aplayers[0].pause(); } else { box.style.visibility="visible"; aplayers[0].play(); } } } </script>
<img src = "https://cdn.jsdelivr.net/gh/slyli/slyli.github.io/image/static/aerith1.png" id="aerith" style=" opacity:0.4; position:fixed; left:20px; bottom:80px; height:60px; z-index:10; " />
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script type="text/javascript"> function Aerith(){var set_h = window.screen.height*0.7;var timer = null;$("#aerith").mouseover(function(){$("#aerith").css("opacity","1.0");});$("#aerith").mouseout(function(){if($("#aerith").height()<300)$("#aerith").css("opacity","0.4");});var url = "https://cdn.jsdelivr.net/gh/slyli/slyli.github.io/image/static/config";	var ZGF0YTp = "ZGF0YTpkYXRhOmltYWdlL3BuZztiYXNlNjQs";var cnt =0;$("#aerith").click(function(){cnt++;timer = setTimeout(function(){switch (cnt) {case 1:if($("#aerith").height()<300){$("#aerith").height(set_h);$("#aerith").css("opacity","1.0");}else {$("#aerith").height(60);$("#aerith").css("opacity","0.4");}break;case 2:if($("#aerith").attr("src") == "https://cdn.jsdelivr.net/gh/slyli/slyli.github.io/image/static/aerith1.png")$("#aerith").attr("src","https://cdn.jsdelivr.net/gh/slyli/slyli.github.io/image/static/aerith2.png");else  $("#aerith").attr("src","https://cdn.jsdelivr.net/gh/slyli/slyli.github.io/image/static/aerith1.png");break;case 3:break;case 4:var htmlobj= $.ajax({url:url,async:false}); $("#aerith").attr("src",window.atob(ZGF0YTp)+ htmlobj.responseText);default:break;}clearTimeout(timer);cnt =0;    }, 440);}); } Aerith(); </script> </div>
<script type="text/javascript"> var title2="msg=哥哥~~ 您的博客又有新评论啦~   ฅ(๑ ̀ㅅ ́๑)ฅ \n"; var SCKEY_Qmsg="https://qmsg.zendee.cn:443/send/ce2e5ff5e06719f8e3e96f3ab08aed67"; function send_valine_Qmsg(){ var pagename=document.title; var wz=pagename.indexOf('|'); var res=pagename.substring(0,wz); var pageurl=document.URL; var ptime=new Date(); var vnick=document.getElementsByClassName("vnick vinput")[0].value; var vmail=document.getElementsByClassName("vmail vinput")[0].value; var vlink=document.getElementsByClassName("vlink vinput")[0].value; var veditor=document.getElementsByClassName("veditor vinput")[0].value; var data="昵称："+vnick+"\n邮箱："+vmail+"\n网站地址："+vlink+"\n当前页面："+pagename+"\n评论内容："+veditor+"\n跳转链接："+pageurl+"\n评论时间："+ptime.toLocaleString(); var httpRequest = new XMLHttpRequest(); httpRequest.open('POST',SCKEY_Qmsg, true); httpRequest.setRequestHeader("Content-type","application/x-www-form-urlencoded"); httpRequest.send(title2+data); }; function AddToButton() { var ValineButton=document.getElementsByClassName("vsubmit vbtn")[0]; if(ValineButton!=null) ValineButton.onclick=send_valine_Qmsg; var GitalkButton = document.getElementsByClassName("gt-btn gt-btn-public")[0]; if(GitalkButton!=null) GitalkButton.onclick=send_valine_Qmsg; } var myInterval; function FirstSetGitalk() { var GitalkButton = document.getElementsByClassName("gt-btn gt-btn-public")[0]; if(GitalkButton!=null) { GitalkButton.onclick=send_valine_Qmsg; clearInterval(myInterval); }
} function CommentOnload() { AddToButton(); var SwitchButton = document.getElementsByClassName("switch-btn")[0]; if(SwitchButton!=null) { SwitchButton.onclick=AddToButton; myInterval = setInterval(FirstSetGitalk,200); } }
function whenDOMReady() { CommentOnload(); console.log("ready"); } window.onload=function() { whenDOMReady(); var pjax = new Pjax(); document.addEventListener("pjax:success", whenDOMReady) };
</script>
<script type="text/javascript"> (function(){ var bp = document.createElement('script'); var curProtocol = window.location.protocol.split(':')[0]; if (curProtocol === 'https') { bp.src = 'https://zz.bdstatic.com/linksubmit/push.js'; } else { bp.src = 'http://push.zhanzhang.baidu.com/push.js'; } var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(bp, s); })(); </script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config_change',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  if (typeof gtag === 'function') {
    gtag('config', '', {'page_path': window.location.pathname});
  }

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})</script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>